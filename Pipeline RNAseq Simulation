# Creating an environment
conda create --name phindhack_covdifex
conda activate phindhack_covdifex

# Installing tools for RNAseq data analysis
conda install -c bioconda sra-tool
conda install -c bioconda fastqc
conda install -c bioconda skewer
conda install -c bioconda star
conda install -c bioconda htseq

# Generating yml file
conda env export > phindhack_covdifex

# Downloading SRR 
fastq-dump --gzip --origfmt --split-files --skip-technical SRR11241433 SRR11241435


# Downloading Reference sequence
wget ftp://ftp.ensembl.org/pub/release-101/fasta/saccharomyces_cerevisiae/dna/Saccharomyces_cerevisiae.R64-1-1.dna.chromosome.VIII.fa.gz

# Quality Control Checking
fastqc ~/*fastq.gz -o

# Trimming
skewer ~/SRR11241435_1_fastq.gz \
                -x TGGAATTCTCGGGTGCCAAGG \
                -o SRR11241435_1_trim \
                -z

# Downloading Annotated Ref sequence
wget ftp://ftp.ensembl.org/pub/release-101/gff3/saccharomyces_cerevisiae/Saccharomyces_cerevisiae.R64-1-1.101.chromosome.VIII.gff3.gz

# Indexation
STAR --runMode genomeGenerate 
     --genomeDir index_star_chr8 \
     --genomeFastaFiles ~/reference_chr8/Saccharomyces_cerevisiae.R64-1-1.dna.chromosome.VIII.fa \
     --sjdbGTFfile ~/reference_chr8/Saccharomyces_cerevisiae.R64-1-1.101.chromosome.VIII.gff3 \
     --sjdbOverhang 48 --genomeSAindexNbases 8 \
     --outFileNamePrefix Scerevisiae_chr8 \
     --runThreadN 2

# Mapping and counting
for fastq in ~/*-trimmed.fastq.gz; 
do echo $fastq; 
STAR --genomeDir index_star_chr8 
     --readFilesIn $fastq 
     --readFilesCommand zcat 
     --outSAMtype BAM SortedByCoordinate 
     --quantMode GeneCounts 
     --outFileNamePrefix alignments_STAR/$(basename $fastq -trimmed.fastq.gz); 
done

head SRR11241433_1_trimReadsPerGene.out.tab

#output
N_unmapped        3212824 3212824 3212824
N_multimapping     8347     8347       8347
N_noFeature        11363   210080     13660
N_ambiguous        0             0             0
MissingGeneID        206149       7432    203852 

# Counting with htseq
htseq-count -f bam -s yes -m intersection-strict ~/mapping/alignments_STAR/SRR11241433_1_trimAligned.sortedByCoord.out.bam \
            ~/reference_chr8/Saccharomyces_cerevisiae.R64-1-1.101.chromosome.VIII.gff3 > SRR11241433_1.counts.txt
            
# Output
Error occured when processing GFF file (line 12 of file /home/formation/reference_chr8/Saccharomyces_cerevisiae.R64-1-1.101.chromosome.VIII.gff3):
  Feature transcript:YHL050C_mRNA does not contain a 'gene_id' attribute
  [Exception type: ValueError, raised in count.py:88]
